#: --skip-racket -fno-gc-refcount -fno-gc-cycle-detection

# Tests garbage collection of 10 element simple cycles (C10).

import runtime;

node{^
    {
        {^cell
            {^next
                ^cell {(^next)}
            }
        }(__cell[])
    }
};

!benchmark{n{^ 10000}; ops{^ 10}; refcount_cycle_broken} {
    # Create 10 nodes.
    1 := (node[]);
    2 := (node[]);
    3 := (node[]);
    4 := (node[]);
    5 := (node[]);
    6 := (node[]);
    7 := (node[]);
    8 := (node[]);
    9 := (node[]);
    10 := (node[]);

    # Link them into a cycle.
    ($1) ($2);
    ($2) ($3);
    ($3) ($4);
    ($4) ($5);
    ($5) ($6);
    ($6) ($7);
    ($7) ($8);
    ($8) ($9);
    ($9) ($10);
    ($10) ($1);

    # Leak the nodes.
    1 := nil;
    2 := nil;
    3 := nil;
    4 := nil;
    5 := nil;
    6 := nil;
    7 := nil;
    8 := nil;
    9 := nil;
    10 := nil;

    .
};

!gc_collect;
!gc_print_stats;
!gc_check_collect;
.
