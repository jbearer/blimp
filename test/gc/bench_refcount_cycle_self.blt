#: --skip-racket -fno-gc-tracing -fno-gc-cycle-detection

# Tests garbage collection of self-cycles. Creates 100k objects and gives
# each one a reference to itself.
#
# This is the same test as tracing_cycle_self, but it runs with reference
# counting on and tracing is disabled. It should be faster than the tracing
# version of the test, otherwise reference counting isn't gaining us anything
# compared to tracing.

import runtime;

!benchmark{n{^ 100000}; refcount_cycle_self} {
    obj{^ (__cell[]) };

    # Create an object which is just a setter for `self`.
    obj {
        {^self
            self {^ (^self)}
        }
    };

    # Create a self-cycle.
    obj{^} (obj{^});

    # Leak the object
    obj{.}
};

!gc_print_stats;
!gc_expect_clean;
.
