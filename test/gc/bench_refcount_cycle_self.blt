#: --skip-racket -fno-gc-tracing -fno-gc-cycle-detection

# Tests garbage collection of self-cycles. Creates 1 million objects, each of
# which has two references to itself: the special `this` reference, and a user-
# created `self` reference.
#
# This is the same test as tracing_cycle_self, but it runs with reference
# counting on and tracing is disabled. It should be slower than the tracing
# version of the test, otherwise reference counting isn't gaining us anything
# compared to tracing.

bind test.go1 (
    self{:=|this{.get|.}}
);

{!benchmark|n{:=|1000000}} {refcount_cycle_self|
    {test|.}{.go1|.}
};

{gc|.}{!print_stats|.};

{gc|.}{!expect_clean|.};
    # Reference counting with entanglement is supposed to be able to perfectly
    # clean up self-cycles. The only allocated objects should be reachable ones.
.
